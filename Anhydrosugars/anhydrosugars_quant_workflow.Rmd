---
title: "Anhydrosugars Quantification Workflow"
author: "AMP"
date: "`r Sys.Date()`"
output: html_document
---

Set up your enviroment: 

```{r environment set up}
require(pacman)
pacman::p_load(tidyverse,
               stringr,
               EnvStats) 

getwd()
```


This script pulls in data that is exported from the Agilent QQQ in csv format from the QuantCSV template.

It is an extremely messy template output, so first step is to bring that in, then clean it up!

```{r import data}

levo_raw <- read_csv("./Example_data/RC3_BSLE_Anhydrosugars_0001-0021.csv", skip =1, 
                     col_names = c("header", "area", "file_path", "instrument")) %>%
  mutate(row_number = row_number())  # Add a row number for reference

levo_raw_areas <- levo_raw %>%
  mutate(is_levoglucosan = ifelse(str_detect(header, "Levoglucosan") & !str_detect(header, "13C-Levoglucosan"), TRUE, FALSE)) %>%
  filter(is_levoglucosan) %>% # Filter rows with "Levoglucosan" which is the rows with the areas
  select(area, row_number, is_levoglucosan) %>%
  rename(levoglucosan_area = area) 

levo13C_raw_areas <- levo_raw %>%
  mutate(is_13Clevoglucosan = ifelse(str_detect(header, "13C-Levoglucosan"), TRUE, FALSE)) %>%
  filter(is_13Clevoglucosan) %>% # Filter rows with "Levoglucosan" which is the rows with the areas
  select(area, row_number, is_13Clevoglucosan) %>%
  rename(C13_levoglucosan_area = area) 

sample_names <- levo_raw %>%
  select(header, row_number, instrument) %>%
  mutate(is_samplename = ifelse(str_detect(instrument, "LC-MS TQ MCRL"), TRUE, FALSE)) %>%
  filter(is_samplename) %>% # Filter rows with "LC-MS TQ MCRL" which is the rows with the sample names
  select(row_number, is_samplename, header)

levo_raw_data <- levo_raw_areas %>%
  full_join(sample_names, by= "row_number") %>%
  full_join(levo13C_raw_areas, by= "row_number") %>%
  arrange(row_number) %>%
  fill(header, .direction = "down") %>%
  group_by(header) %>%
  summarize_all(~ na.omit(.)[1]) %>%
  select(header, levoglucosan_area,C13_levoglucosan_area) %>%
  ungroup()

```
 transmute(target_row = row_number - n) %>% # Calculate target rows
  filter(target_row > 0) %>% # Filter out invalid indices
  inner_join(df, by = c("target_row" = "row_number")) # Join with the original dataframe to get the actual rows

  slice(which(Field_Name == "#Start_Data"):which(Field_Name == "#End_Data"))
